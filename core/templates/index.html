<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KÃ¼tÃ¼phane Platformu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .card-img-top { height: 300px; object-fit: cover; }
        .search-box { max-width: 600px; margin: 50px auto; }
        .navbar-brand { font-weight: bold; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">Sosyal KÃ¼tÃ¼phane</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    {% if user.is_authenticated %}
                        <li class="nav-item me-3">
                            <span class="text-white">
                                <i class="fas fa-user-circle me-1"></i> {{ user.username }}
                            </span>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Ã‡Ä±kÄ±ÅŸ Yap</a>
                        </li>
                    {% else %}
                        <li class="nav-item me-2">
                            <a href="{% url 'login' %}" class="btn btn-outline-light btn-sm">GiriÅŸ</a>
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'register' %}" class="btn btn-primary btn-sm">KayÄ±t Ol</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="search-box text-center">
            {% if user.is_authenticated %}
                <h2 class="mb-4">HoÅŸ geldin, {{ user.username }}! ðŸ‘‹</h2>
                <p class="text-muted">BugÃ¼n ne keÅŸfetmek istersin?</p>
            {% else %}
                <h1 class="mb-4">Sosyal KÃ¼tÃ¼phane</h1>
            {% endif %}

            <div class="input-group mb-3 shadow-sm">
                <input type="text" id="searchInput" class="form-control" placeholder="Film veya Kitap Ara... (Ã–rn: Matrix)">
                <button class="btn btn-primary" onclick="searchContent()">
                    <i class="fas fa-search"></i> Ara
                </button>
            </div>
        </div>

        <div id="resultsArea" class="row mt-5">
            </div>
    </div>

    <script>
        async function searchContent() {
            const query = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('resultsArea');
            
            if (!query) return;

            resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">AranÄ±yor...</p></div>';

            try {
                // API isteÄŸi
                const response = await fetch(`/api/search/?q=${query}`);
                const data = await response.json();

                resultsDiv.innerHTML = ''; 

                // --- FÄ°LMLERÄ° LÄ°STELE ---
                if (data.movies && data.movies.length > 0) {
                    resultsDiv.innerHTML += '<h4 class="mb-3 border-bottom pb-2">Filmler</h4>';
                    
                    data.movies.forEach(movie => {
                        // Poster kontrolÃ¼
                        const poster = movie.poster_path 
                            ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` 
                            : 'https://via.placeholder.com/500x750?text=Resim+Yok';

                        const html = `
                        <div class="col-md-3 col-6 mb-4">
                            <div class="card h-100 shadow-sm border-0">
                                <img src="${poster}" class="card-img-top rounded-top" alt="${movie.title}">
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title fw-bold">${movie.title}</h6>
                                    <p class="card-text text-muted small mb-3">${movie.release_date ? movie.release_date.slice(0, 4) : 'Tarih Yok'}</p>
                                    
                                    <a href="/movie/${movie.id}/" class="btn btn-sm btn-outline-primary mt-auto">
                                        Detay GÃ¶r
                                    </a>
                                </div>
                            </div>
                        </div>`;
                        resultsDiv.innerHTML += html;
                    });
                    // --- KITAPLARI LÄ°STELE ---
                if (data.books && data.books.length > 0) {
                    resultsDiv.innerHTML += '<h4 class="mb-3 mt-5 border-bottom pb-2">Kitaplar</h4>';
                    
                    data.books.forEach(book => {
                        const cover = book.cover_url ? book.cover_url : 'https://via.placeholder.com/128x190?text=No+Cover';
                        
                        const html = `
                        <div class="col-md-3 col-6 mb-4">
                            <div class="card h-100 shadow-sm border-0">
                                <img src="${cover}" class="card-img-top" alt="${book.title}" style="height: 250px; object-fit: contain; padding: 10px; background: #f8f9fa;">
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title fw-bold small">${book.title}</h6>
                                    <p class="card-text text-muted small mb-2">${book.authors}</p>
                                    
                                    <a href="/book/${book.google_id}/" class="btn btn-sm btn-outline-dark mt-auto">
                                        KitabÄ± GÃ¶r
                                    </a>
                                </div>
                            </div>
                        </div>`;
                        resultsDiv.innerHTML += html;
                    });
                }
                } else {
                    resultsDiv.innerHTML = '<div class="alert alert-warning text-center">Film bulunamadÄ±.</div>';
                }

            } catch (error) {
                console.error('Hata:', error);
                resultsDiv.innerHTML = '<div class="alert alert-danger">Bir hata oluÅŸtu!</div>';
            }
        }

        // Enter tuÅŸu ile arama yapabilme
        document.getElementById("searchInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                searchContent();
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>