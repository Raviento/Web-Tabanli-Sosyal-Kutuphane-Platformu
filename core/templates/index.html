{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .search-box { max-width: 600px; margin: 50px auto; }
    .feed-avatar { width: 40px; height: 40px; object-fit: cover; border: 2px solid #2c3440; }
    .feed-poster { width: 70px; height: 100px; object-fit: cover; border-radius: 5px; }
    
    /* Landing Page Styles */
    .landing-title {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 3.5rem;
        font-weight: 700;
        text-shadow: 0 4px 15px rgba(0,0,0,0.8);
        letter-spacing: 1px;
    }
    .btn-join {
        transition: all 0.3s ease;
        font-size: 1.2rem;
        padding: 15px 50px;
    }
    .btn-join:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    }
</style>
{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        <div class="search-box text-center">
            <h2 class="mb-4 text-white">Ho≈ü geldin, {{ user.username }}! üëã</h2>
            <p class="text-muted">Bug√ºn ne ke≈üfetmek istersin?</p>

            <form action="{% url 'search_page' %}" method="GET">
                <div class="input-group mb-3 shadow-lg">
                    <input type="text" name="q" class="form-control bg-input text-white border-secondary" placeholder="Film veya Kitap Ara... (√ñrn: Matrix)">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search"></i> Ara
                    </button>
                </div>
            </form>
        </div>

        {% if not request.GET.q and activities %}
        <div id="feedArea" class="row mt-5 justify-content-center">
            <div class="col-md-8">
                <h5 class="text-muted mb-4 border-bottom border-secondary pb-2"><i class="fas fa-stream"></i> {{ page_title|default:"Son Aktiviteler" }}</h5>
                
                <div id="activity-container">
                    {% for activity in activities %}
                        {% include 'partials/activity_card.html' %}
                    {% endfor %}
                </div>

                {% if activities.has_next %}
                    <div class="text-center mt-4 mb-5">
                        <button id="load-more-btn" class="btn btn-outline-primary px-4 py-2" data-next-page="{{ activities.next_page_number }}">
                            <i class="fas fa-sync-alt me-2"></i> Daha Fazla Y√ºkle
                        </button>
                    </div>
                {% endif %}

            </div>
        </div>
        {% endif %}
    {% else %}
        <!-- Landing Page for Guests -->
        <div class="full-screen-bg text-center text-white p-4">
            <h1 class="landing-title mb-4">Bug√ºn ne ke≈üfetmek istersin?</h1>
            <p class="lead mb-5 text-light opacity-75 fs-4">Filmler, kitaplar ve arkada≈ülarƒ±nla dolu bir d√ºnya seni bekliyor.</p>
            <a href="{% url 'register' %}" class="btn btn-primary btn-join rounded-pill fw-bold shadow-lg">
                <i class="fas fa-user-plus me-2"></i> Aramƒ±za Katƒ±l
            </a>
        </div>
    {% endif %}
        
{% endblock %}

{% block extra_js %}
    <script>
        function toggleComments(activityId) {
            const commentsDiv = document.getElementById(`comments-${activityId}`);
            commentsDiv.classList.toggle('d-none');
        }

        function copyLink(activityId) {
            const url = `${window.location.origin}/activity/${activityId}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Baƒülantƒ± kopyalandƒ±!');
            });
        }

        function toggleLike(activityId, btn) {
            fetch(`/activity/like/${activityId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'liked') {
                        btn.classList.remove('btn-outline-secondary', 'text-muted');
                        btn.classList.add('btn-danger', 'text-white');
                        btn.querySelector('i').classList.remove('far');
                        btn.querySelector('i').classList.add('fas');
                    } else {
                        btn.classList.remove('btn-danger', 'text-white');
                        btn.classList.add('btn-outline-secondary', 'text-muted');
                        btn.querySelector('i').classList.remove('fas');
                        btn.querySelector('i').classList.add('far');
                    }
                    btn.querySelector('.like-count').textContent = data.like_count;
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function() {
                    const nextPage = this.getAttribute('data-next-page');
                    const btn = this;
                    const originalText = btn.innerHTML;
                    
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...';
                    btn.disabled = true;

                    fetch(`?page=${nextPage}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('activity-container');
                        container.insertAdjacentHTML('beforeend', data.html);
                        
                        if (data.has_next) {
                            btn.setAttribute('data-next-page', data.next_page_number);
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        } else {
                            btn.remove();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        alert('Bir hata olu≈ütu, l√ºtfen tekrar deneyin.');
                    });
                });
            }
        });
    </script>
{% endblock %}