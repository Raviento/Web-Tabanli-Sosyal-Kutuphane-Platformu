{% extends 'base.html' %}

{% block title %}{{ movie.title }} - Detay{% endblock %}

{% block content %}
    <div class="row mt-4 mb-5">
        <div class="col-md-4">
            {% if movie.poster_path %}
            <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" class="img-fluid rounded shadow-lg w-100" alt="{{ movie.title }}">
            {% else %}
            <div class="bg-card d-flex align-items-center justify-content-center text-white rounded" style="height: 500px;">
                Resim Yok
            </div>
            {% endif %}
        </div>

        <div class="col-md-8">
            <h1 class="display-4 fw-bold text-white">
                {{ movie.title }} 
                <span class="text-muted fs-3">
                    ({% if movie.release_date %}{{ movie.release_date|slice:":4" }}{% else %}Tarih Yok{% endif %})
                </span>
            </h1>
            
            <div class="mb-3">
                {% for genre in movie.genres %}
                    <span class="badge bg-card border border-secondary me-1">{{ genre.name }}</span>
                {% endfor %}
            </div>

            <div class="d-flex align-items-center mb-4">
                <div class="me-4 text-center">
                    <i class="fas fa-star text-warning fa-2x"></i>
                    <div class="fs-3 fw-bold text-white">{{ movie.vote_average|floatformat:1 }}</div>
                    <div class="text-muted small">TMDb</div>
                </div>
                <div class="text-center border-start border-secondary ps-4">
                    <i class="fas fa-users text-info fa-2x"></i>
                    <div class="fs-3 fw-bold text-white">
                        {% if platform_stats.avg_score %}
                            {{ platform_stats.avg_score|floatformat:1 }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="text-muted small">{{ platform_stats.total_votes }} Oy (Platform)</div>
                </div>
            </div>

            <div class="row mb-4 p-3 bg-card rounded border border-secondary">
                <div class="col-md-4">
                    <strong class="d-block text-info">Yayın Tarihi:</strong>
                    <span class="text-white">{{ movie.release_date|default:"Belirtilmemiş" }}</span>
                </div>
                <div class="col-md-4">
                    <strong class="d-block text-info">Süre:</strong>
                    <span class="text-white">
                    {% if movie.runtime %}
                        <i class="far fa-clock"></i> {{ movie.runtime }} dakika
                    {% else %}
                        Belirtilmemiş
                    {% endif %}
                    </span>
                </div>
                <div class="col-md-4">
                    <strong class="d-block text-info">Orijinal Dil:</strong>
                    <span class="text-white">{{ movie.original_language|upper }}</span>
                </div>
            </div>

            <h4 class="border-bottom border-secondary pb-2 text-white">Özet</h4>
            <p class="lead text-white-50" style="font-size: 1rem;">{{ movie.overview|default:"Bu film için özet bulunmuyor." }}</p>

            <div class="mt-4">
                {% for crew in movie.credits.crew %}
                    {% if crew.job == 'Director' %}
                        <p class="mb-2 text-white"><strong class="text-warning">Yönetmen:</strong> {{ crew.name }}</p>
                    {% endif %}
                {% endfor %}

                <h5 class="mt-3 text-muted border-bottom border-secondary pb-2">Oyuncular</h5>
                <div class="row g-2">
                    {% for actor in movie.credits.cast|slice:":6" %}
                    <div class="col-md-2 col-4 text-center">
                        {% if actor.profile_path %}
                            <img src="https://image.tmdb.org/t/p/w200{{ actor.profile_path }}" class="rounded-circle shadow-sm mb-2" style="width: 70px; height: 70px; object-fit: cover;">
                        {% else %}
                            <div class="rounded-circle bg-card border border-secondary mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
                                <i class="fas fa-user text-white"></i>
                            </div>
                        {% endif %}
                        <p class="small fw-bold mb-0 text-truncate text-white">{{ actor.name }}</p>
                        <p class="text-muted x-small text-truncate" style="font-size: 11px;">{{ actor.character }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% if user.is_authenticated %}
            <div class="card bg-card mt-4 p-3 border-secondary">
                <h5 class="mb-3 text-white"><i class="fas fa-list"></i> Listene Ekle</h5>
                <div class="d-flex gap-2 flex-wrap">
                    
                    <button class="btn {% if 'watched' in standard_lists_containing %}btn-success{% else %}btn-outline-success{% endif %} flex-grow-1" 
                            onclick="toggleList('watched', null, this)">
                        <i class="fas fa-check"></i> İzledim
                    </button>
                    
                    <button class="btn {% if 'watchlist' in standard_lists_containing %}btn-primary{% else %}btn-outline-primary{% endif %} flex-grow-1" 
                            onclick="toggleList('watchlist', null, this)">
                        <i class="fas fa-bookmark"></i> İzlenecek
                    </button>

                    <div class="dropdown flex-grow-1">
                        <button class="btn btn-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                            Özel Listeler
                        </button>
                        <ul class="dropdown-menu w-100 bg-card border-secondary">
                            {% for ulist in user_lists %}
                                {% if ulist.list_type == 'custom' %}
                                <li>
                                    <a class="dropdown-item d-flex justify-content-between align-items-center text-white hover-bg-dark" 
                                       href="#" 
                                       onclick="toggleList('custom', '{{ ulist.id }}', this); return false;">
                                        {{ ulist.name }}
                                        {% if ulist.id in lists_containing_movie %}
                                            <i class="fas fa-check text-success ms-2"></i>
                                        {% endif %}
                                    </a>
                                </li>
                                {% endif %}
                            {% endfor %}
                            <li><hr class="dropdown-divider border-secondary"></li>
                            <li><a class="dropdown-item text-white" href="{% url 'profile' user.username %}"><i class="fas fa-cog"></i> Listeleri Yönet</a></li>
                        </ul>
                    </div>

                    <button class="btn btn-warning text-dark fw-bold flex-grow-1" data-bs-toggle="modal" data-bs-target="#ratingModal">
                        <i class="fas fa-star"></i> {% if user_rating %}Puanım: {{ user_rating.score }}{% else %}Puan Ver{% endif %}
                    </button>
                </div>
                <div id="statusMessage" class="mt-2"></div>
            </div>
            {% else %}
            <div class="alert alert-dark mt-4 border-secondary bg-card text-white">
                <i class="fas fa-lock"></i> Listeye eklemek ve yorum yapmak için <a href="{% url 'login' %}" class="alert-link text-info">Giriş Yapın</a>.
            </div>
            {% endif %}

            <div class="mt-5">
                <h4 class="border-bottom border-secondary pb-2 mb-4 text-white">Yorumlar ({{ reviews|length }})</h4>
                
                {% if user.is_authenticated %}
                <form action="{% url 'add_review' %}" method="POST" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="target_type" value="movie">
                    <input type="hidden" name="target_id" value="{{ movie.id }}">
                    <div class="mb-2">
                        <textarea name="text" class="form-control bg-input text-white border-secondary" rows="3" placeholder="Bu film hakkında ne düşünüyorsun?" required></textarea>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary btn-sm">Yorum Yap</button>
                    </div>
                </form>
                {% endif %}

                {% for review in reviews %}
                <div class="card bg-card border border-secondary mb-3">
                    <div class="card-body text-white">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-center">
                                {% if review.user.profile.avatar %}
                                    <img src="{{ review.user.profile.avatar.url }}" class="rounded-circle me-2" width="40" height="40" style="object-fit: cover;">
                                {% else %}
                                    <img src="/media/avatars/usericon.png" class="rounded-circle me-2" width="40" height="40">
                                {% endif %}
                                <div>
                                    <h6 class="mb-0 fw-bold">
                                        <a href="{% url 'profile' review.user.username %}" class="text-decoration-none text-white">{{ review.user.username }}</a>
                                    </h6>
                                    <small class="text-white-50">{{ review.created_at|date:"d F Y, H:i" }}</small>
                                </div>
                            </div>
                            {% if request.user == review.user %}
                                <div>
                                    <button class="btn btn-link text-info p-0 me-2" onclick="openEditModal('{{ review.id }}', '{{ review.text|escapejs }}')"><i class="fas fa-edit"></i></button>
                                    <a href="{% url 'delete_review' review.id %}" class="text-danger" onclick="return confirm('Silmek istediğine emin misin?')"><i class="fas fa-trash"></i></a>
                                </div>
                            {% endif %}
                        </div>
                        <p class="mt-3 mb-0">{{ review.text }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">Henüz yorum yapılmamış. İlk yorumu sen yap!</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-card text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Puan Ver</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'add_rating' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="target_type" value="movie">
                    <input type="hidden" name="target_id" value="{{ movie.id }}">
                    <div class="modal-body text-center">
                        <div class="rating-stars mb-3">
                            {% for i in "1234567890"|make_list %} <!-- 10'a kadar döngü -->
                                <input type="radio" class="btn-check" name="score" id="rate{{ forloop.counter }}" value="{{ forloop.counter }}" {% if user_rating.score == forloop.counter %}checked{% endif %} required>
                                <label class="btn btn-outline-warning rounded-circle m-1" for="rate{{ forloop.counter }}" style="width: 40px; height: 40px; line-height: 25px;">{{ forloop.counter }}</label>
                            {% endfor %}
                        </div>
                        <p class="text-muted small">1 (Çok Kötü) - 10 (Mükemmel)</p>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-warning">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-card text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Yorumu Düzenle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editReviewForm" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        <textarea name="text" id="editReviewText" class="form-control bg-input text-white border-secondary" rows="4" required></textarea>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Güncelle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function openEditModal(reviewId, text) {
            const form = document.getElementById('editReviewForm');
            const textarea = document.getElementById('editReviewText');
            
            form.action = `/review/edit/${reviewId}/`;
            textarea.value = text;
            
            const modal = new bootstrap.Modal(document.getElementById('editReviewModal'));
            modal.show();
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function toggleList(listType, listId, element) {
            let action = 'add_to_list';
            
            if (element.tagName === 'BUTTON') {
                if (element.classList.contains('btn-success') || element.classList.contains('btn-primary')) {
                    action = 'remove_from_list';
                }
            } else if (element.tagName === 'A') {
                if (element.querySelector('.fa-check')) {
                    action = 'remove_from_list';
                }
            }

            const csrftoken = getCookie('csrftoken');
            const formData = new FormData();
            formData.append('action', action);
            formData.append('target_type', 'movie');
            formData.append('target_id', '{{ movie.id }}');
            
            if (listId) {
                formData.append('list_id', listId);
            } else {
                formData.append('list_type', listType);
            }

            // Movie details
            formData.append('title', '{{ movie.title|escapejs }}');
            formData.append('poster_path', '{{ movie.poster_path }}');
            formData.append('release_date', '{{ movie.release_date }}');
            formData.append('overview', '{{ movie.overview|escapejs }}');
            formData.append('vote_average', '{{ movie.vote_average }}');

            fetch('{% url "movie_interaction" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'added' || data.status === 'removed') {
                    location.reload();
                } else {
                    alert(data.message || 'Bir hata oluştu.');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        async function rateMovie() {
            let score = prompt("Puanınız (1-10):");
            if (score != null) {
                alert("Puanlama API'si henüz bağlanmadı ama listeye ekleme çalışıyor!");
            }
        }
    </script>
{% endblock %}